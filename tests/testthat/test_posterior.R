context("Testing posterior functions")

y = c(1.8878591, 2.0330432, 2.0814903, 0.5589895, 1.8287781, 0.8775885, 1.0996713, 0.7377017, 2.0694030, 1.1522436, 1.0090911, 1.4063387, 2.0181216, 1.1675739, 1.3072470, 0.5710762, 0.8034047, 1.6028377, 1.8618891, 2.2398090, 1.6868311, 0.9023928, 1.3127395, 1.4217525, 2.2993722, 1.0296409, 2.2057257, 2.1207406, 0.5644852, 1.9901668, 1.2576660, 1.9904829, 1.1439910, 0.7592147, 2.3658932, 1.9219454, 1.3662794, 1.8710485, 1.2882794, 0.7712708, 1.7125689, 1.0368137, 1.2083555, 1.0037067, 0.8953093, 2.0763744, 2.3082481, 1.6239396, 0.8776231, 1.1233766, 1.4094944, 1.3414677, 1.3111621, 1.5444465, 1.8660774, 1.5393142, 1.1321836, 1.3105190, 1.2230161, 0.8935941, 1.1115479, 2.1186119, 1.7275909, 1.9835548, 0.6131862, 1.0864589, 0.6312181, 0.2879299, 1.4750630, 1.6925288, 1.6097719, 1.1652726, 1.5899699, 0.5750531, 0.8053554, 1.3503544, 1.1349106, 1.3772842, 1.2159498, 0.7528200, 0.7746530, 1.1892362, 1.2463635, 1.8512873, 0.4304054, 1.3872829, 1.2250037, 1.3562416, 0.3576442, 1.5858671, 1.9312244, 2.4896493, 1.3196600, 1.5135028, 1.1581042, 1.1773002, 1.7286302, 1.4516617, 1.8313651, 1.5815738)

x = c(0.590294194, 0.990642775, 0.875526718, 0.135226476, 0.661512672, 0.182958807, 0.319359086, 0.307629094, 0.941692864, 0.012722500, 0.337077908, 0.361720363, 0.969710945, 0.486596873, 0.401173268, 0.230394415, 0.386505685, 0.561916031, 0.629610641, 0.952750752, 0.703854772, 0.245514332, 0.248546292, 0.573834643, 0.994824463, 0.009693145, 0.899776916, 0.696203884, 0.147521457, 0.547114299, 0.243000922, 0.922276723, 0.122834368, 0.343130254, 0.814002348, 0.586410430, 0.243772228, 0.692205475, 0.277164425, 0.227609297, 0.932059668, 0.340731791, 0.294110334, 0.471066099, 0.428323406, 0.858448194, 0.914264084, 0.706583430, 0.431561207, 0.037935818, 0.294395781, 0.211702665, 0.516184011, 0.800716966, 0.682295427, 0.399877366, 0.035898424, 0.126761658, 0.312184521, 0.415349697, 0.140602947, 0.881761820, 0.868256426, 0.963409868, 0.221831854, 0.014906754, 0.264899154, 0.012109711, 0.731322664, 0.380849675, 0.499127345, 0.539927264, 0.859292293, 0.022485330, 0.236554316, 0.743405057, 0.387403657, 0.229609848, 0.069816766, 0.290530889, 0.217502033, 0.643494022, 0.223237823, 0.624175089, 0.103999967, 0.628946671, 0.446707789, 0.462677360, 0.021932597, 0.865770870, 0.897365800, 0.963298090, 0.627042271, 0.584131283, 0.041863574, 0.504678814, 0.951675174, 0.529856420, 0.506388396, 0.466260099)

predicted_y = c(1.5164760, 2.0310493, 1.8830891, 0.9315715, 1.6080141, 0.9929225, 1.1682396, 1.1531629, 1.9681333, 0.7741156, 1.1910138, 1.2226871, 2.0041453, 1.3831925, 1.2733964, 1.0538921, 1.2545440, 1.4800012, 1.5670100, 1.9823462, 1.6624369, 1.0733260, 1.0772230, 1.4953203, 2.0364241, 0.7702219, 1.9142582, 1.6526031, 0.9473744, 1.4609763, 1.0700954, 1.9431775, 0.9156438, 1.1987930, 1.8040110, 1.5114842, 1.0710868, 1.6474639, 1.1140062, 1.0503124, 1.9557516, 1.1957102, 1.1357870, 1.3632306, 1.3082928, 1.8611379, 1.9328788, 1.6659441, 1.3124544, 0.8065226, 1.1361539, 1.0298674, 1.4212212, 1.7869352, 1.6347264, 1.2717308, 0.8039039, 0.9206916, 1.1590180, 1.2916176, 0.9384820, 1.8911032, 1.8737445, 1.9960465, 1.0428866, 0.7769230, 1.0982415, 0.7733279, 1.6977418, 1.2472742, 1.3992981, 1.4517387, 1.8622228, 0.7866639, 1.0618095, 1.7132714, 1.2556982, 1.0528837, 0.8474996, 1.1311863, 1.0373214, 1.5848545, 1.0446937, 1.5600236, 0.8914357, 1.5661566, 1.3319225, 1.3524484, 0.7859534, 1.8705498, 1.9111592, 1.9959028, 1.5637088, 1.5085547, 0.8115710, 1.4064335, 1.9809637, 1.4387946, 1.4086308, 1.3570534)

prior = make_prior(alpha = 1, n = 2)
df = data.frame(y,x)
model = y~x
posterior = fit_model(model, df, prior, beta = 1)



test_that("test the fit_model function", {
  modelMatrix = make_model_matrix(model,df)
  response = model.response(model.frame(model, df))

  expect_equal(posterior[[1]], (1 * solve(prior$covar + 1 * t(modelMatrix) %*% modelMatrix)) %*% t(modelMatrix) %*% response)
  expect_equal(posterior[[2]], solve(prior$covar + 1 * t(modelMatrix) %*% modelMatrix))
})

test_that("test the predict_response function", {
  modelMatrix = make_responseless_matrix(model, df)
  response = predict_response(df, posterior, model, beta = 1)

  expect_equal(response[[1]], apply(modelMatrix, 1, function(predictor) t(posterior$mean) %*% predictor))
  expect_equal(response[[2]], apply(modelMatrix, 1, function(predictor) 1/1 + t(predictor) %*% posterior$covar %*% predictor))
})

